
iSpeechRecognizer=function(params){this.commands=[];this.aliasList={};this.optionalCommands={};this.endpoint="wss://malcom.ispeech.org:8431/";params=params||{};this.apiKey=params.apiKey||"developerdemokeydeveloperdemokey";this.onResponse=params.onResponse||this.onResponse;this.silenceDetection=params.silenceDetection||true;this.workerLoc=params.workerLoc||'iSpeechWorker.min.js';window.navigator=window.navigator||{};navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||null;if(navigator.getUserMedia===null){this.onResponse({result:'error',code:10001,message:'Browser not supported'});return;}
this.audioContext=null;}
iSpeechRecognizer.IDLE=0;iSpeechRecognizer.WAITING_USER=1;iSpeechRecognizer.RECORDING=2;iSpeechRecognizer.prototype.state=iSpeechRecognizer.IDLE;iSpeechRecognizer.prototype.switchState=function(state){this.state=state;this.onStateChange(state);}
iSpeechRecognizer.prototype.isBrowserSupported=function(){return navigator.getUserMedia!=null;}
iSpeechRecognizer.prototype.start=function(){if(this.state!=iSpeechRecognizer.IDLE)
return;navigator.getUserMedia({video:false,audio:true},this.startRecording.bind(this),function(error){this.onResponse({result:'error',code:10001,message:'Audio capture error: '+error.code});}.bind(this));this.switchState(iSpeechRecognizer.WAITING_USER);}
iSpeechRecognizer.prototype.startRecording=function(localMediaStream){var AudioContext=window.AudioContext||window.webkitAudioContext;this.audioContext=new AudioContext();this.mediaStream=localMediaStream;var source=this.audioContext.createMediaStreamSource(localMediaStream);this.context=source.context;this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,8192,1,1);this.worker=new Worker(this.workerLoc);this.worker.onmessage=this.onWorkerMessage.bind(this);this.worker.postMessage({command:'start',params:{apiKey:this.apiKey,srcSampleRate:this.context.sampleRate,options:this.commandArgs(),endpoint:this.endpoint,silenceDetection:this.silenceDetection}});this.node.onaudioprocess=this.processAudio.bind(this);source.connect(this.node);this.node.connect(this.context.destination);this.switchState(iSpeechRecognizer.RECORDING);}
iSpeechRecognizer.prototype.processAudio=function(e){var buffer=[];buffer=e.inputBuffer.getChannelData(0);this.worker.postMessage({command:'process',buffer:buffer});}
iSpeechRecognizer.prototype.onWorkerMessage=function(e){switch(e.data.command){case'result':if(!!this.onResponse)
this.onResponse(e.data.result);break;case'con':this.webSocket=new(WebSocket||MozWebSocket)(this.endpoint);this.webSocket.onopen=function(){this.worker.postMessage({command:'socketOpen'});}.bind(this);this.webSocket.onerror=function(){this.onWorkerMessage({command:'errorConnecting'});}.bind(this);this.webSocket.onclose=function(){this.worker.terminate();}.bind(this);this.webSocket.onmessage=function(x){var res=JSON.parse(x.data);this.onWorkerMessage({data:{command:'result',result:res}});if(res.result.toLowerCase()=="success"){this.webSocket.close();}}.bind(this);break;case'send':if(!!this.webSocket)
this.webSocket.send(e.data.data);break;case'errorConnecting':this.onResponse({result:'error',code:10002,message:'Error connecting to server'});break;case'stop':this.stop();break;case'log':console.log(e.data);break;}}
iSpeechRecognizer.prototype.onResponse=function(resp){console.log(resp);}
iSpeechRecognizer.prototype.onStateChange=function(state){console.log("new state: "+state);}
iSpeechRecognizer.prototype.stop=function(){if(this.state!=iSpeechRecognizer.RECORDING)
return;this.switchState(iSpeechRecognizer.IDLE);this.worker.postMessage({command:'stop'});if(this.mediaStream.stop){this.mediaStream.stop();}else{var tracks=this.mediaStream.getTracks();for(var i=0;i<tracks.length;i++){tracks[i].stop();}}
this.node.disconnect();this.node.onaudioprocess=function(){};if(this.audioContext.close)this.audioContext.close();}
iSpeechRecognizer.prototype.addCommand=function(command){this.commands=this.commands.concat(command);}
iSpeechRecognizer.prototype.addAlias=function(alias,values){this.aliasList[alias]=[].concat(values);}
iSpeechRecognizer.prototype.addOptionalCommand=function(key,value){this.optionalCommands[key]=value;}
iSpeechRecognizer.prototype.setLocale=function(locale){this.addOptionalCommand("locale",locale);}
iSpeechRecognizer.prototype.clearCommandAndAlias=function(){this.commands=[];this.aliasList={};this.optionalCommands={};}
iSpeechRecognizer.prototype.pipeSeparate=function(list){var ret=encodeURIComponent(list[0]);for(var i=1;i<list.length;i++){ret+="|"+encodeURIComponent(list[i]);}
return ret;}
iSpeechRecognizer.prototype.commandArgs=function(){var ret="";var alias=[];for(var i=0;i<this.commands.length;i++){alias.push("command"+(i+1));ret+="&"+alias[i]+"="+encodeURIComponent(this.commands[i]);}
for(var key in this.aliasList){ret+="&"+encodeURIComponent(key.toUpperCase())+"="+this.pipeSeparate(this.aliasList[key]);alias.push(key.toUpperCase());}
if(alias.length>0)
ret+="&alias="+this.pipeSeparate(alias);for(var key in this.optionalCommands){ret+="&"+encodeURIComponent(key)+"="+encodeURIComponent(this.optionalCommands[key]);}
return ret;}